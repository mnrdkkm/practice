<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>フラッシュ点数計算</title>
<style>
  :root{
    --bg:#114f40;
    --board:#175c4b;
    --frame:#0b3b31;
    --panel-h:56px;
    --line: rgba(0,0,0,.12);
  }
  html,body{margin:0;padding:0;background:#0e4b3e;color:#0e241f;font-family:system-ui, -apple-system, "Segoe UI", Roboto, "ヒラギノ角ゴ ProN", "Hiragino Kaku Gothic ProN", "Noto Sans JP", Meiryo, sans-serif;}
  .wrap{
    max-width:1100px;margin:0 auto;padding:24px;
  }
  h1{color:#fff;margin:0 0 10px;font-weight:900;letter-spacing:.12em;text-shadow:0 2px 0 #09382e;}
  /* 外枠 */
  .stage{
    background: radial-gradient(1200px 400px at 50% -200px, rgba(255,255,255,.18), transparent 60%) #155a49;
    border:6px solid #0c4337;border-radius:22px; padding:18px;
    box-shadow: inset 0 0 0 6px rgba(255,255,255,.06);
  }

  /* 上部コントロール */
  .ctrl-row{display:flex;flex-wrap:wrap;align-items:center;justify-content:center;gap:16px;margin:6px 0 14px;}
  .chips{display:flex;flex-wrap:wrap;gap:12px;}
  .chip{
    min-width:120px; height:54px; padding:0 16px;
    display:flex;align-items:center;justify-content:center;
    background:linear-gradient(#ffe8a6,#ffe29a);
    border:1px solid #e1c468;border-radius:12px;
    font-weight:800; letter-spacing:.12em;
    color:#634f05; user-select:none;
  }
  .ctrl-buttons{display:flex;gap:14px;align-items:center;}
  .btn{border-radius:16px;padding:14px 30px;font-weight:900;letter-spacing:.2em;font-size:18px;cursor:pointer;transition:transform .02s;}
  .btn:active{transform:translateY(1px)}
  .btn-start{background:#117a5d;color:#fff;border:3px solid #0b5b46;box-shadow:0 2px 0 #06382c;}
  .btn-ghost{background:#fff;border:2px solid #0b5b46;color:#0b5b46;}
  .btn:disabled{opacity:.45;cursor:not-allowed}

  /* 出題パネル */
  .qa-area{background:#0e4b3e33;border:2px solid #0c4337;border-radius:16px;padding:14px 12px;margin:0 0 18px;}
  .qa-meta{display:flex;align-items:center;gap:8px;color:#dfe; font-weight:800; letter-spacing:.14em; margin:2px 4px 10px}
  .answers{display:grid;grid-template-columns:repeat(2,minmax(220px,1fr));gap:14px 18px;max-width:900px;margin:0 auto 6px;transition:opacity .18s}
  .ansBtn{
    padding:16px 22px;border-radius:14px;border:3px solid rgba(0,0,0,.25);
    background: linear-gradient(#2f66a4 0%, #d5e6f7 55%, #ffffff 100%);
    color:#111;font-weight:900;letter-spacing:.04em;font-size:20px;cursor:pointer;transition:transform .03s;
  }
  .ansBtn:active{transform:translateY(1px)}
  .disabled{opacity:.6;pointer-events:none}

  /* 見出し */
  .panel{background:#f7fbfa;border-radius:18px;border:1px solid rgba(0,0,0,.15);overflow:hidden}
  .grid-panels{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:960px){ .grid-panels{grid-template-columns:1fr} }
  .panel-hd{min-height:var(--panel-h);display:flex;align-items:center;gap:10px;padding:10px 16px;font-weight:900;letter-spacing:.2em}
  .panel-qa .panel-hd{background:linear-gradient(#ffefb9,#fdeea2)}
  .panel-judge .panel-hd{background:linear-gradient(#e9f3ff,#ddeefe)}
  .panel-bd{padding:10px 14px 14px;background:#fff}

  /* テーブル */
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px 12px}
  thead th{color:#222;font-weight:800}

  tbody tr{border-top:1px solid var(--line)}
  .qaTab th, .qaTab td{text-align:center}
  .jgTab td{vertical-align:middle}
  .jgTab td.sel, .jgTab td.ans{text-align:left}
  .right{ text-align:right }

  /* ○× */
  .mark{display:inline-block;width:22px;height:22px;vertical-align:middle;position:relative}
  .ok{border:3px solid #1e73d4;border-radius:50%;box-shadow:0 0 0 2px #fff inset}
  .ng::before,.ng::after{
    content:"";position:absolute;left:2px;right:2px;top:50%;border-top:3px solid #d53a3a;box-shadow:0 0 0 2px #fff inset
  }
  .ng::before{transform:translateY(-50%) rotate(45deg)}
  .ng::after{transform:translateY(-50%) rotate(-45deg)}

  .muted{color:#567}
  .note{font-size:12px;color:#567;margin-top:4px}

/* --- 横線をくっきり表示（問題/正誤判定 共通） --- */
.qaTab tbody tr+tr td,
.jgTab tbody tr+tr td{
  border-top: 2px solid rgba(15, 36, 42, .28); /* 線の色/濃さはここで調整 */
}

/* 1行目は線なし（念のため） */
.qaTab tbody tr:first-child td,
.jgTab tbody tr:first-child td{
  border-top: none;
}

/* 行の高さが詰まりすぎるときは少し余白を追加 */
.qaTab td, .jgTab td{
  padding-top: 10px;
  padding-bottom: 10px;
}


</style>
</head>
<body>
<div class="wrap">
  <h1>フラッシュ点数計算</h1>
  <div class="stage">
    <!-- 上部操作 -->
    <div class="ctrl-row">
      <div class="chips" id="chips">
        <span class="chip" id="chip-parent">親／子</span>
        <span class="chip" id="chip-tr">ツモ／ロン</span>
        <span class="chip" id="chip-fu">符</span>
        <span class="chip" id="chip-han">翻</span>
      </div>
      <div class="ctrl-buttons">
        <button class="btn btn-start" id="btnStart">スタート</button>
        <button class="btn btn-ghost" id="btnReset">↺ やり直し</button>
      </div>
    </div>

    <!-- 出題表示 -->
    <div class="qa-area" id="qaArea" hidden>
      <div class="qa-meta" id="qMeta">第<span id="qNo">01</span>問</div>
      <div class="answers" id="answers"></div>
    </div>

    <!-- 結果 -->
    <div class="grid-panels" id="resultWrap" hidden>
      <section class="panel panel-qa">
        <div class="panel-hd">問題</div>
        <div class="panel-bd">
          <table class="qaTab">
            <thead>
            <tr><th>No.</th><th>親／子</th><th>ツモ／ロン</th><th>符</th><th>翻</th></tr>
            </thead>
            <tbody id="qaTbody"></tbody>
          </table>
        </div>
      </section>
      <section class="panel panel-judge">
        <div class="panel-hd">正誤判定</div>
        <div class="panel-bd">
          <table class="jgTab">
            <thead>
            <tr><th>正誤</th><th>あなたの選択</th><th>正解</th></tr>
            </thead>
            <tbody id="jgTbody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";

  // ---------- utilities ----------
  const rand = (n)=> Math.floor(Math.random()*n);
  const choice = (arr)=> arr[rand(arr.length)];
  const ceil100 = (x)=> Math.ceil(x/100)*100;

  // Mahjong calc
  function calcPoint({isParent, isTsumo, fu, han}){
    // base point
    // limit check
    let limit = null; // '満貫' etc
    let base = fu * Math.pow(2, han + 2); // 基本点
    if (han >= 13)       { limit='役満';  }
    else if (han >= 11)  { limit='三倍満';}
    else if (han >= 8)   { limit='倍満';  }
    else if (han >= 6)   { limit='跳満';  }
    else if (han >= 5)   { limit='満貫';  }
    else if (base >= 2000){ limit='満貫'; }

    // limit payments table
    const limRon   = isParent?  {満貫:12000, 跳満:18000, 倍満:24000, 三倍満:36000, 役満:48000}
                              : {満貫: 8000, 跳満:12000, 倍満:16000, 三倍満:24000, 役満:32000};
    const limTAll  =           {満貫: 4000, 跳満: 6000, 倍満: 8000, 三倍満:12000, 役満:16000}; // 親ツモ オール
    const limChild =           {満貫:[2000,4000], 跳満:[3000,6000], 倍満:[4000,8000], 三倍満:[6000,12000], 役満:[8000,16000]}; // 子ツモ [子,親]

    let disp='', norm='', suffix='';
    if (limit){
      suffix = `（${limit}）`;
      if (!isTsumo){
        const v = limRon[limit];
        disp = String(v); norm = disp;
      }else{
        if (isParent){
          const pay = limTAll[limit];
          disp = `${pay}オール`; norm = disp;
        }else{
          const [c,p] = limChild[limit];
          disp = `${c*1000/1000}/${p*1000/1000}`; // 2000/4000 など
          disp = `${c}/${p}`; norm = disp;
        }
      }
      return {disp, norm, suffix, limit};
    }

    // 非満貫
    if (!isTsumo){
      const ron = isParent ? ceil100(base*6) : ceil100(base*4);
      disp = String(ron); norm = disp;
    }else{
      if (isParent){
        const all = ceil100(base*2);
        disp = `${all}オール`; norm = disp;
      }else{
        const ko = ceil100(base);      // 子支払い
        const oya = ceil100(base*2);   // 親支払い
        disp = `${ko}/${oya}`; norm = disp;
      }
    }
    return {disp, norm, suffix, limit:null};
  }

  // distractors generator
  function genDistractors(ans, meta){
    const set = new Set([ans.norm]);
    const list = [];
    const push = (s)=>{ if(!set.has(s)){ set.add(s); list.push(s);} };

    // 近傍の誤答を作る
    const vary = ()=>{
      const {isParent,isTsumo} = meta;
      if (!isTsumo){
        // ron single number
        let v = parseInt(ans.norm,10);
        const delta = [100,200,300,400,500][rand(5)];
        const s1 = String(v + delta);
        const s2 = String(Math.max(1000, v - delta));
        push(s1); push(s2);
      }else if(isParent){
        // parent tsumo Xオール
        const m = ans.norm.match(/^(\d+)オール$/);
        if (m){
          const x = parseInt(m[1],10);
          push(`${x+200}オール`);
          push(`${Math.max(200,x-200)}オール`);
        }
      }else{
        // child tsumo a/b
        const m = ans.norm.match(/^(\d+)\/(\d+)$/);
        if (m){
          let a = parseInt(m[1],10), b = parseInt(m[2],10);
          push(`${a+100}/${b+200}`);
          push(`${Math.max(100,a-100)}/${Math.max(200,b-200)}`);
        }
      }
    };
    vary();

    // 型違いのひっかけ
    if (meta.isTsumo && !meta.isParent){
      push(ans.norm.replace('/','／'));
      push(`${ans.norm.split('/')[1]}オール`);
    }else if(meta.isTsumo && meta.isParent){
      push(ans.norm.replace('オール',' オール'));
      push(ans.norm.replace('オール',''));
    }else{
      push(String(parseInt(ans.norm,10)+700));
      push(`${ans.norm}点`);
    }

    // 3つに制限
    while(list.length>3) list.splice(rand(list.length),1);
    return list.slice(0,3);
  }

  // ---------- game state ----------
  const MAXQ = 10;
  let qIndex = 0;
  const history = []; // {meta, disp, ans, ok}

  const $ = (sel)=> document.querySelector(sel);

  const chips = {
    parent: $('#chip-parent'),
    tr:     $('#chip-tr'),
    fu:     $('#chip-fu'),
    han:    $('#chip-han'),
  };
  const qaArea   = $('#qaArea');
  const answers  = $('#answers');
  const resultWrap = $('#resultWrap');
  const qaTbody  = $('#qaTbody');
  const jgTbody  = $('#jgTbody');

  // ---------- question generation ----------
  function nextMeta(){
    const isParent = !!rand(2);          // 親:1 子:0
    const isTsumo  = !!rand(2);          // ツモ:1 ロン:0
    let fuCand = [20,25,30,40,50,60,70,80,90,110];
    // ロンで20符は不可
    let fu = choice(fuCand);
    if (!isTsumo && fu===20) fu = 30;

    // たまに大きめ符
    if (rand(12)===0) fu = choice([90,110]);

    const han = choice([1,2,3,4,5,6,7,8,9,10,11,12,13]);

    return {isParent,isTsumo,fu,han};
  }

  function metaLabel(m){
    return {
      parent: m.isParent? '親':'子',
      tr:     m.isTsumo? 'ツモ':'ロン',
      fu:     `${m.fu}符`,
      han:    `${m.han}翻`,
    };
  }

  function buildChoices(meta){
    const ans  = calcPoint(meta);
    const dums = genDistractors(ans, meta);
    const all  = [ans.norm, ...dums];
    // shuffle
    for(let i=all.length-1;i>0;i--){
      const j = rand(i+1); const t=all[i]; all[i]=all[j]; all[j]=t;
    }
    // 表示文字列は ans.norm と同じフォーマット
    return {correct: ans, options: all};
  }

  function setChips(meta){
    const lab = metaLabel(meta);
    chips.parent.textContent = lab.parent;
    chips.tr.textContent     = lab.tr;
    chips.fu.textContent     = lab.fu;
    chips.han.textContent    = lab.han;
  }

  function drawQuestion(){
    if (qIndex>=MAXQ){ showResult(); return; }

    qaArea.hidden = false;
    resultWrap.hidden = true;

    const meta = nextMeta();
    setChips(meta);

    const {correct, options} = buildChoices(meta);
    answers.innerHTML = '';
    options.forEach(txt=>{
      const b = document.createElement('button');
      b.className='ansBtn';
      b.textContent = txt;
      b.addEventListener('click', ()=>{
        const ok = (txt===correct.norm);
        history.push({meta, sel:txt, ans:correct.disp+(correct.suffix||''), ok});
        // 軽いフェードで次へ
        answers.style.opacity='0';
        setTimeout(()=>{
          answers.style.opacity='1';
          qIndex++;
          drawQuestion();
        },180);
      });
      answers.appendChild(b);
    });
  }

  // ---------- result ----------
  function showResult(){
    qaArea.hidden = true;
    resultWrap.hidden = false;

    // 表クリア
    qaTbody.innerHTML=''; jgTbody.innerHTML='';

    history.forEach((h,i)=>{
      const lab = metaLabel(h.meta);
      const tr1 = document.createElement('tr');
      tr1.innerHTML = `<td>${String(i+1).padStart(2,'0')}</td><td>${lab.parent}</td><td>${lab.tr}</td><td>${lab.fu}</td><td>${lab.han}</td>`;
      qaTbody.appendChild(tr1);

      const tr2 = document.createElement('tr');
      const mark = `<span class="mark ${h.ok?'ok':'ng'}"></span>`;
      tr2.innerHTML = `<td>${mark}</td><td class="sel">${h.sel}</td><td class="ans">${h.ans}</td>`;
      jgTbody.appendChild(tr2);
    });
  }

  // ---------- controls ----------
  function renderInitView(){
    // 初期ラベル
    chips.parent.textContent='親／子';
    chips.tr.textContent='ツモ／ロン';
    chips.fu.textContent='符';
    chips.han.textContent='翻';

    qIndex=0; history.length=0;
    answers.innerHTML='';
    qaArea.hidden = true;
    resultWrap.hidden = true;
  }

  document.getElementById('btnStart').addEventListener('click', ()=>{
    renderInitView();
    qaArea.hidden=false;
    drawQuestion();
  });

  document.getElementById('btnReset').addEventListener('click', ()=>{
    renderInitView();
  });

  // 初期
  renderInitView();
})();
</script>
</body>
</html>
