<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>å½¹åˆ¤å®šã‚¯ã‚¤ã‚ºï¼ˆå’Œäº†å½¢ã‹ã‚‰ç¬¦ã¨ç¿»æ•°ã‚’è¨ˆç®—ï¼‰</title>
<style>
  :root{ --w: clamp(44px, 8.2vw, 64px); --h: calc(var(--w) * 1.45); }
  *{ box-sizing: border-box; }
  body{ font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin:12px; text-align:center; }
  h2{ font-size: clamp(16px, 4.5vw, 22px); margin: 0.2em 0 0.3em; }

  /* ãƒ¡ã‚¿ï¼ˆå¤§ãã‚ï¼†ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºï¼‰ */
  .meta{ font-size: clamp(18px, 4.5vw, 24px); margin-bottom:.6rem; display:flex; gap:12px; justify-content:center; flex-wrap:wrap; font-weight:900; }
  .badge{ padding:6px 12px; border-radius:999px; background:#eef3ff; border:2px solid #c7d6ff; font-weight:900; }
  .badge.group{ display:inline-flex; align-items:center; gap:10px; }
  .badge.group .sep{ opacity:.55; }

  /* ç‰Œ */
  .handRow{ display:flex; justify-content:center; align-items:center; gap:18px; margin:6px 0 8px; }
  .board{ display:flex; justify-content:center; flex-wrap:wrap; gap:6px; background:#0b6623; padding:10px; border-radius:10px; min-height: calc(var(--h) + 20px); }
  .winWrap{ position:relative; display:flex; align-items:center; }
  .winTile{ position:relative; }
  .winLabel{
    position:absolute; top:-10px; left:50%; transform:translateX(-50%);
    font-weight:800; font-size:12px; background:#fff; border:1px solid #bbb; border-radius:999px; padding:2px 6px;
    /* â† æŠ˜è¿”ã—é˜²æ­¢ãƒ»æ¨ªæ›¸ãå›ºå®š */
    white-space: nowrap; writing-mode: horizontal-tb; text-orientation: mixed;
    display:inline-flex; align-items:center; justify-content:center; min-width:max-content;
  }
  .spacer{ width:14px; height:2px; background:linear-gradient(90deg, transparent 0 30%, #0b6623 30% 70%, transparent 70% 100%); border-radius:2px; }

  .tile{ width:var(--w); height:var(--h); border:2px solid #8a8a8a; border-radius:6px; background:#fff;
         box-shadow: inset 0 0 0 2px #fff, 0 1px 2px rgba(0,0,0,.06); display:flex; align-items:center; justify-content:center;
         writing-mode: vertical-rl; text-orientation: upright; font-size:clamp(20px, calc(var(--w)*0.54), 36px); font-weight:800; color:#000; line-height:1; user-select:none; position:relative; }
  .tile.m{ background:#fdecea; } /* è¬ï¼šè–„èµ¤ */
  .tile.p{ background:#eaf3fd; } /* ç­’ï¼šè–„é’ */
  .tile.s{ background:#eafded; } /* ç´¢ï¼šè–„ç·‘ */
  .m{ color:#c62828; } .p{ color:#1565c0; } .s{ color:#2e7d32; } .honor{ color:#000; }
  .tile .num{ color:#000; }
  .tile.mini{ width:calc(var(--w)*0.6); height:calc(var(--h)*0.6); font-size:clamp(12px, calc(var(--w)*0.32), 18px); border-width:2px; } /* ãƒŸãƒ‹ç‰Œï¼ˆãƒ‰ãƒ©è¡¨ç¤ºç”¨ï¼‰ */

  /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
  .controlRow{ display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap; margin:.4rem 0 .6rem; }
  .controlRow button{ padding:10px 14px; border-radius:12px; border:1px solid #777; background:#f7f7f7; font-weight:800; font-size:clamp(14px,3.4vw,16px); }
  .controlRow label{ display:inline-flex; align-items:center; gap:6px; font-weight:700; }
  .controlRow select{ padding:8px 10px; border-radius:10px; border:1px solid #777; font-weight:700; }

  /* â–¼ ç‰Œã‚µã‚¤ã‚ºï¼ˆâª / â©ï¼‰ */
  .sizeControls{
    display:flex; gap:10px; align-items:center; justify-content:center;
    margin:.25rem 0 .65rem;
  }
  .sizeControls .btn{
    padding:8px 12px; border-radius:10px; border:1px solid #777;
    background:#f7f7f7; font-weight:800; font-size:clamp(14px,3.4vw,16px);
    cursor:pointer;
  }
  .sizeControls .btn:hover{ background:#f1f1f1; }
  .sizeControls .label{
    min-width:72px; text-align:center; font-weight:900;
    padding:4px 8px; border-radius:999px; border:2px solid #c7d6ff; background:#eef3ff;
    font-variant-numeric: tabular-nums;
  }

  /* çµæœã‚¨ãƒªã‚¢ï¼šå¸¸è¨­ï¼ˆé«˜ã•ç¢ºä¿ï¼‰ */
  #resultPanel{ min-height: 5.6em; display:flex; flex-direction:column; gap:.15rem; align-items:center; justify-content:flex-start; margin:.4rem 0 .6rem; }
  /* çŠ¶æ…‹ã‚¯ãƒ©ã‚¹ï¼ˆOK/æƒœã—ã„/ä¸æ­£è§£ï¼‰ */
  #result.ok   { color:#0a7d00; }
  #result.near { color:#b08900; }
  #result.bad  { color:#b00020; }
  #result .mark{ color:#f6c000; font-weight:900; margin-right:.15em; }

  #yakuLine{ font-weight:700; }
  #fuLine{ color:#444; }
  #err{ color:#d32f2f; font-weight:700; font-size:12px; margin-top:6px; }

  /* â–¼ å½¹ãƒ¡ãƒ¢ / ç‚¹æ•°è¡¨ åˆ‡æ›¿ã‚¿ãƒ– */
  .switchTabs{display:flex;gap:8px;justify-content:center;margin:10px 0 6px}
  .switchTabs .tab{ padding:8px 14px;border-radius:999px;border:1px solid #b6bfd6;background:#f6f7fb;font-weight:800;cursor:pointer }
  .switchTabs .tab.active{background:#e7eeff;border-color:#7ea6ff}

  /* å½¹ãƒ¡ãƒ¢ */
  .memo{ margin:12px auto 8px; max-width:980px; text-align:left; }
  .memo h3{ font-size:14px; margin:.4rem 0; }
  .memo .headNote{ font-size:12px; color:#555; font-weight:700; margin-left:.4em; }
  .yakuSection{ display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:8px 10px; align-items:start; margin:8px 0 16px; }
  .yakuSection h4{ grid-column:1 / -1; font-weight:800; margin:.2rem 0; }
  .yakuBtn{ display:inline-block; padding:6px 10px; border-radius:999px; background:#f6f7fa; border:1px solid #d8deef; font-weight:700; font-size:13px; white-space:nowrap; cursor:pointer; }
  .yakuBtn.selected{ background:#fff9db; border-color:#e6c85c; }

  /* â–¼ ç‚¹æ•°è¡¨ */
  .scoreWrap{display:flex;gap:18px;justify-content:center;flex-wrap:wrap}
  .scoreCard{border:2px solid #d7dde8;border-radius:10px;overflow:hidden;background:#fff}
  .scoreCard h4{ margin:0;padding:8px 14px;color:#fff;font-size:15px;letter-spacing:.06em }
  .scoreCard.child h4{background:#ef6f6c}
  .scoreCard.parent h4{background:#59a9ea}
  .scoreTable{border-collapse:separate;border-spacing:0}
  .scoreTable th,.scoreTable td{ border-right:1px solid #dfe5f0;border-bottom:1px solid #dfe5f0; padding:8px 10px;font-weight:800;text-align:center;min-width:74px }
  .scoreTable th.head{background:#f0f2f8}
  .scoreTable th.fu{background:#c7ebb9}
  .scoreTable td.picked{background:#fff2b3 !important; box-shadow: inset 0 0 0 2px #e0c14e}
  .scoreTable td:hover{background:#f9fbff}

  /* ===== ç”»é¢å¹…ãƒ•ã‚£ãƒƒãƒˆèª¿æ•´ï¼ˆã‚¹ãƒãƒ›æœ€å„ªå…ˆï¼‰ ===== */

  /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Œå…¨ã«æŠ‘æ­¢ã—ã€ãƒãƒƒãƒã®å®‰å…¨é ˜åŸŸã«å¯„ã›ã‚‹ */
  html, body { max-width: 100%; overflow-x: hidden; }
  body{
    margin: clamp(6px, 2.6vw, 12px);
    padding-left:  env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
    padding-bottom: env(safe-area-inset-bottom);
  }

  /* ç‰Œã‚„è¦‹å‡ºã—ã®æ—¢å®šã‚µã‚¤ã‚ºã‚’å°‘ã—ã ã‘å°å›ã‚ŠãŒåˆ©ãã‚ˆã†èª¿æ•´ */
  @media (max-width: 420px){
    :root{
      --w: clamp(34px, 7.0svw, 56px);
      --h: calc(var(--w) * 1.45);
    }
    h2{    font-size: clamp(16px, 5.2vw, 22px); }
    .meta{ font-size: clamp(15px, 4.0vw, 19px); gap: 8px; }
    .badge{ padding: 4px 10px; }
    .handRow{ gap: 12px; }
    .board{ gap: 4px; padding: 8px; }
  }

  /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å„ãƒ–ãƒ­ãƒƒã‚¯ã¯æ¨ªå¹…ã‚’ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« */
  .board, .handRow, .meta, .controlRow, #resultPanel, .memo, .scoreWrap{
    max-width: 100%;
  }

  /* ã‚ãšã‹ãªã‚¬ã‚¿ã¤ãå¯¾ç­–ï¼šç¸¦æŒã¡æ™‚ã¯å¹…ã‚’å®‰å®šã•ã›ã‚‹ï¼ˆsvw ãŒä½¿ãˆã‚‹ç«¯æœ«å„ªå…ˆï¼‰ */
  @supports (width: 1svw){
    @media (orientation: portrait) and (max-width: 900px){
      .memo, .scoreWrap{ margin-left: auto; margin-right: auto; }
    }
  }
</style>
</head>
<body>
  <h2>å½¹åˆ¤å®šã‚¯ã‚¤ã‚ºï¼ˆå’Œäº†å½¢ã‹ã‚‰ç¬¦ã¨ç¿»æ•°ã‚’è¨ˆç®—ï¼‰</h2>
  <div id="meta" class="meta"></div>

  <div class="handRow">
    <div id="hand13" class="board" aria-label="æ‰‹ç‰Œï¼ˆ13æšï¼‰"></div>
    <div class="spacer" aria-hidden="true"></div>
    <div class="winWrap">
      <div id="winTile" class="winTile"></div>
      <div id="winLabel" class="winLabel">ãƒ„ãƒ¢</div>
    </div>
  </div>

  <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div class="controlRow">
    <button type="button" id="btnReveal">ç­”ãˆã‚’è¡¨ç¤º</button>
    <label>ä½•ç¬¦ï¼š<select id="fuSel"><option>--</option><option>20</option><option>25</option><option>30</option><option>40</option><option>50</option><option>60</option><option>70</option></select></label>
    <label>ä½•ç¿»ï¼š<select id="hanSel"><option>--</option></select></label>
    <button type="button" id="btnJudge">è§£ç­”ã™ã‚‹ (Enter)</button>
    <button type="button" id="btnNext">æ¬¡ã®å•é¡Œ (N)</button>
  </div>

  <!-- â–¼ ã‚¿ã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆ20â€“80pxï¼5pxåˆ»ã¿ï¼‰ -->
  <div class="sizeControls" aria-label="ã‚¿ã‚¤ãƒ«ã‚µã‚¤ã‚ºèª¿æ•´">
    <button type="button" id="sizeDown" class="btn">âª å°ã•ã</button>
    <span class="label" id="sizeLabel">--</span>
    <button type="button" id="sizeUp" class="btn">â© å¤§ãã</button>
  </div>

  <!-- çµæœè¡¨ç¤ºé ˜åŸŸï¼ˆå¸¸è¨­ï¼‰ -->
  <div id="resultPanel">
    <div id="result" aria-live="polite"></div>
    <div id="yakuLine" aria-live="polite"></div>
    <div id="fuLine" aria-live="polite"></div>
    <div id="err" aria-live="polite"></div>
  </div>

  <!-- â–¼ å½¹ãƒ¡ãƒ¢ / ç‚¹æ•°è¡¨ åˆ‡æ›¿ã‚¿ãƒ– -->
  <div class="switchTabs">
    <button id="tabMemo"  class="tab active">å½¹ãƒ¡ãƒ¢</button>
    <button id="tabScore" class="tab">ç‚¹æ•°è¡¨</button>
  </div>

  <!-- â–¼ ãƒ‘ãƒãƒ«ï¼šå½¹ãƒ¡ãƒ¢ -->
  <div id="panelMemo">
    <div class="memo" id="yakuMemo">
      <h3>å½¹ä¸€è¦§ <span class="headNote">ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ¢ã«ä½¿ãˆã¾ã™ï¼‰</span></h3>

      <div class="yakuSection">
        <h4>ä¸€é£œ</h4>
        <span class="yakuBtn">è¡¨ãƒ‰ãƒ©</span><span class="yakuBtn">ç«‹ç›´</span><span class="yakuBtn">é–€å‰æ¸…è‡ªæ‘¸å’Œ</span>
        <span class="yakuBtn">æ–­ä¹ˆä¹</span><span class="yakuBtn">å¹³å’Œ</span><span class="yakuBtn">ä¸€ç›ƒå£</span>
        <span class="yakuBtn">å½¹ç‰Œ</span><span class="yakuBtn">å ´é¢¨ç‰Œ</span><span class="yakuBtn">è‡ªé¢¨ç‰Œ</span>
      </div>
      <div class="yakuSection">
        <h4>äºŒé£œ</h4>
        <span class="yakuBtn">ä¸‰è‰²åŒé †</span><span class="yakuBtn">ä¸‰è‰²åŒåˆ»</span><span class="yakuBtn">ä¸€æ°—é€šè²«</span>
        <span class="yakuBtn">æ··å…¨å¸¯ä¹ˆä¹</span><span class="yakuBtn">ä¸ƒå¯¾å­</span><span class="yakuBtn">å¯¾ã€…å’Œ</span>
        <span class="yakuBtn">ä¸‰æš—åˆ»</span><span class="yakuBtn">æ··è€é ­</span><span class="yakuBtn">å°ä¸‰å…ƒ</span>
      </div>
      <div class="yakuSection">
        <h4>ä¸‰é£œ</h4>
        <span class="yakuBtn">æ··ä¸€è‰²</span><span class="yakuBtn">ç´”å…¨å¸¯ä¹ˆä¹</span><span class="yakuBtn">äºŒç›ƒå£</span>
      </div>
      <div class="yakuSection">
        <h4>å…­é£œ</h4>
        <span class="yakuBtn">æ¸…ä¸€è‰²</span>
      </div>
      <div class="yakuSection">
        <h4>å½¹æº€</h4>
        <span class="yakuBtn">å››æš—åˆ»</span><span class="yakuBtn">æ¸…è€é ­</span><span class="yakuBtn">ç·‘ä¸€è‰²</span>
        <span class="yakuBtn">å¤§ä¸‰å…ƒ</span><span class="yakuBtn">å­—ä¸€è‰²</span><span class="yakuBtn">å°å››å–œ</span>
        <span class="yakuBtn">å¤§å››å–œ</span><span class="yakuBtn">ä¹è“®å®ç‡ˆ</span>
      </div>
    </div>
  </div>

  <!-- â–¼ ãƒ‘ãƒãƒ«ï¼šç‚¹æ•°è¡¨ï¼ˆJSã§ç”Ÿæˆï¼‰ -->
  <div id="panelScore" hidden>
    <div class="scoreWrap" id="scoreTables"></div>
  </div>

<script>
(() => {
  const errEl = document.getElementById('err');
  window.onerror = (m, s, l, c, e) => { errEl.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + m; console.error(m, s, l, c, e); };

  const metaEl    = document.getElementById('meta');
  const hand13El  = document.getElementById('hand13');
  const winTileEl = document.getElementById('winTile');
  const winLabel  = document.getElementById('winLabel');
  const fuSel     = document.getElementById('fuSel');
  const hanSel    = document.getElementById('hanSel');
  const btnJudge  = document.getElementById('btnJudge');
  const btnReveal = document.getElementById('btnReveal');
  const btnNext   = document.getElementById('btnNext');

  /* â–¼ ç‰Œã‚µã‚¤ã‚º âª/â© ç”¨è¦ç´  */
  const sizeDown  = document.getElementById('sizeDown');
  const sizeUp    = document.getElementById('sizeUp');
  const sizeLabel = document.getElementById('sizeLabel');

  let dora = {kind:'m', num:5};

  if(hanSel.children.length<=1){
    for(let i=1;i<=13;i++){ const o=document.createElement('option'); o.textContent=String(i); hanSel.appendChild(o); }
  }

  const NUMS = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'];
  const SUIT_LABEL = { m:'è¬', p:'ç­’', s:'ç´¢' };
  const HONOR_LABEL = ['æ±','å—','è¥¿','åŒ—','ç™½','ç™¼','ä¸­'];
  const MARU_NUMS = ['â‘ ','â‘¡','â‘¢','â‘£','â‘¤','â‘¥','â‘¦','â‘§','â‘¨'];

  // çŠ¶æ…‹
  let counts = { m:Array(10).fill(0), p:Array(10).fill(0), s:Array(10).fill(0), z:Array(8).fill(0) };
  let draw   = { kind:'m', num:1 };
  let winType = 'tsumo';
  let isMenzen = true;
  let bakaze = 1, jikaze = 1;
  let isRiichi = false;

  let fuAns = 30, hanAns = 1;
  let lastMelds = [], lastHead = null, base13Counts = null;
  let lastYakuList = [], lastFuBreak = [];

  const randInt = (a,b)=> a+Math.floor(Math.random()*(b-a+1));

  function tileNode(kind,n){
    const d=document.createElement('div');
    d.className='tile ' + kind;
    if(kind==='z'){ d.textContent = HONOR_LABEL[n-1]; d.classList.add('honor'); }
    else{
      const numStr = kind==='m' ? NUMS[n-1] : kind==='p' ? MARU_NUMS[n-1] : String(n);
      d.innerHTML = `<span class="num">${numStr}</span><span class="${kind}">${SUIT_LABEL[kind]}</span>`;
    }
    return d;
  }
  function labelShort(k,n){ if(k==='z') return HONOR_LABEL[n-1]; const suit=k==='m'?'è¬':k==='p'?'ç­’':'ç´¢'; const num=k==='m'?NUMS[n-1]:(k==='p'?MARU_NUMS[n-1]:String(n)); return num+suit; }
  function renderHand13(){
    hand13El.innerHTML='';
    ['m','p','s'].forEach(k=>{ for(let i=1;i<=9;i++) for(let t=0;t<counts[k][i];t++) hand13El.appendChild(tileNode(k,i)); });
    for(let i=1;i<=7;i++) for(let t=0;t<counts.z[i];t++) hand13El.appendChild(tileNode('z',i));
  }
  function renderWin(){
    winTileEl.innerHTML='';
    winTileEl.appendChild(tileNode(draw.kind, draw.num));
    winLabel.textContent = (winType==='tsumo'?'ãƒ„ãƒ¢':'ãƒ­ãƒ³');
  }

  /* ãƒ¡ã‚¿ï¼šå ´é¢¨+è‡ªé¢¨+ãƒ‰ãƒ© / ç«‹ç›´+å’Œäº† ã‚’1ã¤ãšã¤ã«ã¾ã¨ã‚ã‚‹ */
  function updateMeta(){
    metaEl.innerHTML='';
    const windBox = document.createElement('div');
    windBox.className = 'badge group';
    const s1 = document.createElement('span'); s1.textContent = `å ´é¢¨:${bakaze===1?'æ±':'å—'}`;
    const s2 = document.createElement('span'); s2.textContent = `è‡ªé¢¨:${jikaze===1?'æ±':'å—'}`;
    const sep1 = document.createElement('span'); sep1.className='sep'; sep1.textContent='|';
    const sep2 = document.createElement('span'); sep2.className='sep'; sep2.textContent='|';
    const dLabel = document.createElement('span'); dLabel.textContent='ãƒ‰ãƒ©';
    const dTile  = tileNode(dora.kind, dora.num); dTile.classList.add('mini'); dTile.setAttribute('aria-label','ãƒ‰ãƒ©è¡¨ç¤º');
    windBox.append(s1, sep1, s2, sep2, dLabel, dTile);
    metaEl.appendChild(windBox);

    const statusBox = document.createElement('div');
    statusBox.className = 'badge group';
    const s3 = document.createElement('span'); s3.textContent = `ç«‹ç›´:${isRiichi?'æœ‰':'ç„¡'}`;
    const sep3 = document.createElement('span'); sep3.className='sep'; sep3.textContent='|';
    const s4 = document.createElement('span'); s4.textContent = `å’Œäº†:${winType==='tsumo'?'ãƒ„ãƒ¢':'ãƒ­ãƒ³'}`;
    statusBox.append(s3, sep3, s4);
    metaEl.appendChild(statusBox);
  }

  /* ä¸€ç›ƒå£/äºŒç›ƒå£ å³å¯†åˆ¤å®šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
  function cloneCounts(c){ return { m:c.m.slice(), p:c.p.slice(), s:c.s.slice(), z:c.z.slice() }; }
  function maxIipeikouPairs(fullCounts){
    let best = 0;
    const pairChoices = [];
    for(const k of ['m','p','s']) for(let n=1;n<=9;n++) if(fullCounts[k][n]>=2) pairChoices.push({k,n});
    for(let n=1;n<=7;n++) if(fullCounts.z[n]>=2) pairChoices.push({k:'z',n});

    const pickFirstTile=(c)=>{
      for(const k of ['m','p','s','z']){
        const maxN=(k==='z'?7:9);
        for(let n=1;n<=maxN;n++) if(c[k][n]>0) return {k,n};
      }
      return null;
    };
    const dfs=(c, melds)=>{
      if(melds.length===4){
        const cnt=new Map();
        for(const m of melds){
          if(m.type==='shuntsu'){
            const key=`${m.k}:${m.n}`;
            cnt.set(key,(cnt.get(key)||0)+1);
          }
        }
        let pairs=0; for(const v of cnt.values()) pairs+=Math.floor(v/2);
        if(pairs>best) best=pairs; return;
      }
      const t=pickFirstTile(c); if(!t) return;
      if(c[t.k][t.n]>=3){ c[t.k][t.n]-=3; if(dfs(c, melds)){ c[t.k][t.n]+=3; return; } c[t.k][t.n]+=3; }
      if(t.k!=='z' && t.n<=7 && c[t.k][t.n+1]>0 && c[t.k][t.n+2]>0){
        c[t.k][t.n]--; c[t.k][t.n+1]--; c[t.k][t.n+2]--;
        melds.push({type:'shuntsu',k:t.k,n:t.n}); dfs(c, melds); melds.pop();
        c[t.k][t.n]++; c[t.k][t.n+1]++; c[t.k][t.n+2]++;
      }
    };
    for(const head of pairChoices){
      const c=cloneCounts(fullCounts);
      c[head.k][head.n]-=2;
      dfs(c, []);
      if(best===2) break;
    }
    return best;
  }

  /* é¢å­ãƒ—ãƒ¼ãƒ«ãƒ»åˆ¤å®šè£œåŠ© */
  const SHUNTSU_POOL=(()=>{ const a=[]; for(const k of ['m','p','s']) for(const n of [1,2,3,4,5,6,7]) a.push({type:'shuntsu',k,n}); return a; })();
  const KOUTSU_POOL =(()=>{ const a=[]; for(const k of ['m','p','s']) for(let n=1;n<=9;n++) a.push({type:'koutsu',k,n}); for(const n of [1,2,3,4,5,6,7]) a.push({type:'koutsu',k:'z',n}); return a; })();
  const TOITSU_POOL =(()=>{ const a=[]; for(const k of ['m','p','s']) for(let n=1;n<=9;n++) a.push({k,n}); for(const n of [1,2,3,4,5,6,7]) a.push({k:'z',n}); return a; })();
  function tilesFromMeld(m){ return m.type==='shuntsu'?[{k:m.k,n:m.n},{k:m.k,n:m.n+1},{k:m.k,n:m.n+2}]:[{k:m.k,n:m.n},{k:m.k,n:m.n},{k:m.k,n:m.n}]; }
  function tilesFromPair(p){ return [{k:p.k,n:p.n},{k:p.k,n:p.n}]; }
  function countsFromTiles(tiles){ const c={m:Array(10).fill(0),p:Array(10).fill(0),s:Array(10).fill(0),z:Array(8).fill(0)}; for(const t of tiles){ if(t.k==='z') c.z[t.n]++; else c[t.k][t.n]++; } return c; }
  function canMentsu(arr){ let i=1; while(i<=9 && arr[i]===0) i++; if(i>9) return true; if(arr[i]>=3){ arr[i]-=3; if(canMentsu(arr)){ arr[i]+=3; return true; } arr[i]+=3; } if(i<=7 && arr[i+1]>0 && arr[i+2]>0){ arr[i]--;arr[i+1]--;arr[i+2]--; if(canMentsu(arr)){ arr[i]++;arr[i+1]++;arr[i+2]++; return true; } arr[i]++;arr[i+1]++;arr[i+2]++; } return false; }
  function isAgariStd(full){
    for(const k of ['m','p','s']) for(let j=1;j<=9;j++) if(full[k][j]>=2){ full[k][j]-=2;
      const ok=canMentsu(full.m.slice())&&canMentsu(full.p.slice())&&canMentsu(full.s.slice())&&[1,2,3,4,5,6,7].every(z=>full.z[z]%3===0);
      full[k][j]+=2; if(ok) return true; }
    for(let j=1;j<=7;j++) if(full.z[j]>=2){ full.z[j]-=2;
      const ok=canMentsu(full.m.slice())&&canMentsu(full.p.slice())&&canMentsu(full.s.slice())&&[1,2,3,4,5,6,7].every(z=>full.z[z]%3===0);
      full.z[j]+=2; if(ok) return true; }
    return false;
  }
  function classifyWait(base13, draw){
    if(draw.kind==='z') return (base13.z[draw.num]>=2)? 'shabo' : 'tanki';
    const c=base13[draw.kind], n=draw.num;
    if(n>=2 && n<=8 && c[n-1]>0 && c[n+1]>0) return 'kanchan';
    if((n===3 && c[1]>0 && c[2]>0) || (n===7 && c[8]>0 && c[9]>0)) return 'penchan';
    if(c[n]>=2) return 'shabo';
    if((n<=7 && c[n+1]>0 && c[n+2]>0) || (n>=3 && c[n-2]>0 && c[n-1]>0)) return 'ryanmen';
    if(c[n]>0) return 'tanki';
    return 'other';
  }

  /* å‡ºé¡Œ */
  function genProblem(){
    bakaze = randInt(1,2); jikaze = randInt(1,2); isMenzen = true; winType = Math.random()<0.5?'tsumo':'ron'; isRiichi = isMenzen && Math.random()<0.5;
    dora = (Math.random()<0.2) ? {kind:'z', num: randInt(1,7)} : {kind: ['m','p','s'][randInt(0,2)], num: randInt(1,9)};

    let made=false;
    for(let tries=0; tries<8000 && !made; tries++){
      let melds=[], useCount=new Map();
      const countMap={m:Array(10).fill(0),p:Array(10).fill(0),s:Array(10).fill(0),z:Array(8).fill(0)};
      const canAdd=tiles=>tiles.every(t=>{ const cur=(t.k==='z'?countMap.z[t.n]:countMap[t.k][t.n]); const add=tiles.filter(x=>x.k===t.k && x.n===t.n).length; return cur+add<=4; });
      const add=tiles=>tiles.forEach(t=>{ if(t.k==='z') countMap.z[t.n]++; else countMap[t.k][t.n]++; });

      while(melds.length<4){
        const pickSeq=Math.random()<0.55; const pool=pickSeq?SHUNTSU_POOL:KOUTSU_POOL; const cand=pool[randInt(0,pool.length-1)];
        const key=cand.type+':'+cand.k+':'+cand.n; const cnt=useCount.get(key)||0; if(cnt>=3) continue;
        const t=tilesFromMeld(cand); if(!canAdd(t)) continue; add(t); melds.push(cand); useCount.set(key,cnt+1);
      }
      let head=null;
      for(let r=0;r<200;r++){ const h=TOITSU_POOL[randInt(0,TOITSU_POOL.length-1)]; const t=tilesFromPair(h); if(canAdd(t)){ add(t); head=h; break; } }
      if(!head) continue;

      let tiles=[]; for(const m of melds) tiles=tiles.concat(tilesFromMeld(m)); tiles=tiles.concat(tilesFromPair(head));
      const idx=Math.floor(Math.random()*tiles.length); const win=tiles[idx]; const rest=tiles.slice(0,idx).concat(tiles.slice(idx+1));
      const c=countsFromTiles(rest); const full=countsFromTiles(rest.concat([win])); if(!isAgariStd(full)) continue;

      counts=c; draw={kind:win.k, num:win.n}; lastMelds=melds.slice(); lastHead=head; base13Counts=c; made=true;
    }

    if(!made){
      counts={m:Array(10).fill(0),p:Array(10).fill(0),s:Array(10).fill(0),z:Array(8).fill(0)};
      counts.m[1]=counts.m[2]=counts.m[3]=1; counts.s[3]=counts.s[4]=counts.s[5]=1; counts.p[7]=3; counts.z[7]=2;
      draw={kind:'p',num:7};
      lastMelds=[{type:'shuntsu',k:'m',n:1},{type:'shuntsu',k:'s',n:3},{type:'koutsu',k:'p',n:7},{type:'koutsu',k:'z',n:7}];
      lastHead={k:'z',n:7}; base13Counts=counts;
    }
  }

  /* å½¹ãƒ»ç¬¦è¨ˆç®— */
  function computeHanFu(){
    if(!base13Counts){
      base13Counts = JSON.parse(JSON.stringify(counts));
      if(!lastMelds.length){ lastMelds=[{type:'shuntsu',k:'m',n:1},{type:'shuntsu',k:'s',n:3},{type:'koutsu',k:'p',n:7},{type:'koutsu',k:'z',n:7}]; }
      if(!lastHead){ lastHead={k:'z',n:7}; }
    }
    lastYakuList = []; lastFuBreak = [];
    const waitType = classifyWait(base13Counts, draw);

    // å½¹æº€ï¼ˆå››æš—åˆ»ã®ã¿ç°¡æ˜“ï¼‰
    const full = JSON.parse(JSON.stringify(base13Counts));
    if(draw.kind==='z') full.z[draw.num]++; else full[draw.kind][draw.num]++;
    const ankoCountAll = lastMelds.filter(m => m.type==='koutsu').length;
    if(isMenzen && ankoCountAll===4 && (winType==='tsumo' || (winType==='ron' && waitType==='tanki'))){
      let fu=20, fb=[];
      for(const m of lastMelds){ if(m.type==='koutsu'){ const add=(m.k==='z'||m.n===1||m.n===9)?8:4; fu+=add; fb.push(`${labelShort(m.k,m.n)}æš—åˆ»(${add})`); } }
      if(waitType==='kanchan'||waitType==='penchan'||waitType==='tanki'){ fu+=2; fb.push(`${waitType==='kanchan'?'ã‚«ãƒ³ãƒãƒ£ãƒ³':waitType==='ãƒšãƒ³ãƒãƒ£ãƒ³'?'ãƒšãƒ³ãƒãƒ£ãƒ³':'å˜é¨'}(2)`); }
      if(winType==='tsumo'){ fu+=2; fb.push('ãƒ„ãƒ¢(2)'); } else if(winType==='ron' && isMenzen){ fu+=10; fb.push('é–€å‰ãƒ­ãƒ³(10)'); }
      fu=Math.ceil(fu/10)*10; fuAns=fu; hanAns=13; lastYakuList=['å››æš—åˆ»']; lastFuBreak=fb; return {fu,hanTotal:13};
    }

    // é€šå¸¸å½¹
    let hanYaku=0, doraHan=0;
    const yakuList=[];

    if(isMenzen && winType==='ãƒ„ãƒ¢'){ /* ä¿é™º */ }
    if(isMenzen && winType==='tsumo'){ hanYaku++; yakuList.push('ãƒ„ãƒ¢'); }
    if(isMenzen && isRiichi){ hanYaku++; yakuList.push('ç«‹ç›´'); }

    for(const m of lastMelds){
      if(m.type==='koutsu' && m.k==='z'){
        if(m.n===5){ hanYaku++; yakuList.push('ç™½'); }
        if(m.n===6){ hanYaku++; yakuList.push('ç™¼'); }
        if(m.n===7){ hanYaku++; yakuList.push('ä¸­'); }
        if(m.n===bakaze){ hanYaku++; yakuList.push('å ´é¢¨ç‰Œ'); }
        if(m.n===jikaze){ hanYaku++; yakuList.push('è‡ªé¢¨ç‰Œ'); }
      }
    }

    if(lastMelds.every(m=>m.type==='koutsu')){ hanYaku+=2; yakuList.push('å¯¾ã€…å’Œ'); }

    // ä¸‰æš—åˆ»ï¼ˆãƒ­ãƒ³ã¯ãã®åˆ»å­é™¤å¤–ï¼‰
    let ankoCount=0;
    for(const m of lastMelds){ if(m.type==='koutsu'){ if(winType==='ron' && draw.kind===m.k && draw.num===m.n) continue; ankoCount++; } }
    if(ankoCount>=3){ hanYaku+=2; yakuList.push('ä¸‰æš—åˆ»'); }

    // å¹³å’Œ
    const headIsVal=(lastHead.k==='z' && (lastHead.n>=5||lastHead.n===bakaze||lastHead.n===jikaze));
    const allShuntsu=lastMelds.every(m=>m.type==='shuntsu');
    const pinfu=isMenzen && allShuntsu && !headIsVal && waitType==='ryanmen';
    if(pinfu){ hanYaku++; yakuList.push('å¹³å’Œ'); }

    // æ–­ä¹ˆä¹
    const sumArr = a => a.reduce((x,y)=>x+y,0);
    let usesHonor=sumArr(base13Counts.z)>0 || (draw.kind==='z'); let has19=false;
    for(const k of ['m','p','s']) for(const i of [1,9]) if((base13Counts[k][i]+(draw.kind===k&&draw.num===i?1:0))>0) has19=true;
    if(!usesHonor && !has19){ hanYaku++; yakuList.push('æ–­ä¹ˆä¹'); }

    // ä¸€ç›ƒå£/äºŒç›ƒå£ï¼ˆé¢å‰ã®ã¿ï¼‰
    if(isMenzen){
      const fullCounts = JSON.parse(JSON.stringify(base13Counts));
      if(draw.kind==='z') fullCounts.z[draw.num]++; else fullCounts[draw.kind][draw.num]++;
      const pairs = maxIipeikouPairs(fullCounts);
      if(pairs>=2){ hanYaku+=3; yakuList.push('äºŒç›ƒå£'); }
      else if(pairs===1){ hanYaku+=1; yakuList.push('ä¸€ç›ƒå£'); }
    }

    // ãƒ‰ãƒ©ï¼ˆç¿»ã®ã¿ï¼‰
    const dCount = (dora.kind==='z'? base13Counts.z[dora.num] : base13Counts[dora.kind][dora.num]) + ((draw.kind===dora.kind && draw.num===dora.num)?1:0);
    for(let i=0;i<dCount;i++) yakuList.push('ãƒ‰ãƒ©');
    doraHan = dCount;

    // --- æœ€ä½1å½¹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‰ãƒ©é™¤ãï¼‰ã€‚ç„¡ã‘ã‚Œã°ï¼šé¢å‰ãƒ­ãƒ³ã¯è‡ªå‹•ç«‹ç›´ä»˜ä¸ã€ãã‚Œä»¥å¤–ã¯ç„¡åŠ¹ ---
    let baseYakuCount = yakuList.filter(y => y !== 'ãƒ‰ãƒ©').length;
    if (baseYakuCount === 0) {
      if (isMenzen && winType === 'ron') {
        isRiichi = true;
        yakuList.push('ç«‹ç›´');
        hanYaku += 1;
      } else {
        return { invalidNoYaku: true };
      }
    }

    // ç¬¦è¨ˆç®—
    let fu=20, fuBreak=[];
    for(const m of lastMelds){
      if(m.type==='koutsu'){
        const isYaochu=(m.k==='z'||m.n===1||m.n===9); const lbl=labelShort(m.k,m.n);
        if(winType==='ron' && draw.kind===m.k && draw.num===m.n){ const v=isYaochu?4:2; fu+=v; fuBreak.push(`${lbl}æ˜åˆ»(${v})`); }
        else{ const v=isYaochu?8:4; fu+=v; fuBreak.push(`${lbl}æš—åˆ»(${v})`); }
      }
    }
    if(lastHead.k==='z'){
      if(lastHead.n===5) { fu+=2; fuBreak.push('ç™½é›€é ­(2)'); }
      if(lastHead.n===6) { fu+=2; fuBreak.push('ç™¼é›€é ­(2)'); }
      if(lastHead.n===7) { fu+=2; fuBreak.push('ä¸­é›€é ­(2)'); }
      if(lastHead.n===bakaze){ fu+=2; fuBreak.push('å ´é¢¨é›€é ­(2)'); }
      if(lastHead.n===jikaze){ fu+=2; fuBreak.push('è‡ªé¢¨é›€é ­(2)'); }
    }
    if(waitType==='kanchan'){ fu+=2; fuBreak.push('ã‚«ãƒ³ãƒãƒ£ãƒ³(2)'); }
    else if(waitType==='penchan'){ fu+=2; fuBreak.push('ãƒšãƒ³ãƒãƒ£ãƒ³(2)'); }
    else if(waitType==='tanki'){ fu+=2; fuBreak.push('å˜é¨(2)'); }

    if(pinfu){ fu = (winType==='tsumo')?20:30; lastFuBreak=[winType==='tsumo'?'å¹³å’Œãƒ„ãƒ¢(20)':'å¹³å’Œãƒ­ãƒ³(30)']; }
    else{
      if(winType==='tsumo'){ fu+=2; fuBreak.push('ãƒ„ãƒ¢(2)'); }
      else if(winType==='ron' && isMenzen){ fu+=10; fuBreak.push('é–€å‰ãƒ­ãƒ³(10)'); }
      const rounded=Math.ceil(fu/10)*10; if(rounded!==fu) fuBreak.push(`åˆ‡ã‚Šä¸Šã’â†’${rounded}ç¬¦`); fu=rounded; lastFuBreak=fuBreak;
    }

    fuAns=fu; hanAns=Math.min(hanYaku + doraHan, 13); lastYakuList=yakuList; return {fu, hanTotal:hanAns};
  }

  /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
  function resetSelectors(){ fuSel.value='--'; hanSel.value='--'; }
  function tilesTotal(c){ let t=0; ['m','p','s'].forEach(k=>{ for(let i=1;i<=9;i++) t+=c[k][i]; }); for(let i=1;i<=7;i++) t+=c.z[i]; return t; }
  function forceFallback(){
    counts={m:Array(10).fill(0),p:Array(10).fill(0),s:Array(10).fill(0),z:Array(8).fill(0)};
    counts.m[1]=counts.m[2]=counts.m[3]=1; counts.s[3]=counts.s[4]=counts.s[5]=1; counts.p[7]=3; counts.z[7]=2;
    draw={kind:'p',num:7};
    lastMelds=[{type:'shuntsu',k:'m',n:1},{type:'shuntsu',k:'s',n:3},{type:'koutsu',k:'p',n:7},{type:'koutsu',k:'z',n:7}];
    lastHead={k:'z',n:7}; base13Counts=counts;
  }
  function clearMemoSelection(){ document.querySelectorAll('.yakuBtn.selected').forEach(b=>b.classList.remove('selected')); }

  function next(){
    // çµæœãƒªã‚»ãƒƒãƒˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼†ã‚¯ãƒ©ã‚¹ï¼‰
    const resultEl = document.getElementById('result');
    resultEl.textContent = '';
    resultEl.className = '';
    document.getElementById('yakuLine').textContent='';
    document.getElementById('fuLine').textContent='';
    document.getElementById('err').textContent='';
    clearMemoSelection();

    base13Counts=null;
    try{
      let tries=0;
      while(true){
        genProblem();
        if(!base13Counts || !draw || !draw.kind || tilesTotal(counts)!==13){
          forceFallback();
          document.getElementById('err').textContent='ç”Ÿæˆãƒªãƒˆãƒ©ã‚¤: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚';
        }
        const r=computeHanFu(); if(r && r.invalidNoYaku){ if(++tries>200){ forceFallback(); break; } continue; } break;
      }
      updateMeta(); renderHand13(); renderWin(); resetSelectors();
    }catch(e){
      console.error(e);
      document.getElementById('err').textContent='åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼: '+e.message;
      forceFallback(); renderHand13(); renderWin(); updateMeta();
    }
    document.querySelectorAll('.scoreTable td.picked')
            .forEach(td => td.classList.remove('picked'));
  }

  /* åˆ¤å®šï¼šOKï¼æƒœã—ã„ï¼ä¸æ­£è§£ï¼ˆã‚¯ãƒ©ã‚¹åˆ‡æ›¿ï¼‰ */
  function judge(){
    const fv = parseInt(fuSel.value, 10);
    const hv = parseInt(hanSel.value, 10);
    const resultEl = document.getElementById('result');

    if(Number.isNaN(fv) || Number.isNaN(hv)){
      resultEl.className = 'bad';
      resultEl.textContent = 'ã¾ãšã€Œä½•ç¬¦ã€ã€Œä½•ç¿»ã€ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚';
      return;
    }

    const fuOK  = (fv === fuAns);
    const hanOK = (hv === hanAns);

    if (fuOK && hanOK) {
      resultEl.className = 'ok';
      resultEl.textContent = `ğŸŸ¢ æ­£è§£ï¼ï¼ˆ${fuAns}ç¬¦ / ${hanAns}ç¿»ï¼‰`;
    } else if (fuOK || hanOK) {
      resultEl.className = 'near';
      resultEl.innerHTML = `<span class="mark">â–²</span>æƒœã—ã„ï¼ â†’ æ­£è§£ã¯ ${fuAns}ç¬¦ / ${hanAns}ç¿»`;
    } else {
      resultEl.className = 'bad';
      resultEl.textContent = `âŒ ä¸æ­£è§£ â†’ æ­£è§£ã¯ ${fuAns}ç¬¦ / ${hanAns}ç¿»`;
    }

    document.getElementById('yakuLine').textContent =
      lastYakuList.length ? lastYakuList.join('ï¼') : 'ï¼ˆå½¹ãªã—ï¼‰';
    document.getElementById('fuLine').textContent  =
      lastFuBreak.length ? lastFuBreak.join('ï¼') : '';
  }

  function reveal(){
    const resultEl = document.getElementById('result');
    resultEl.className = '';
    resultEl.textContent = `æ­£è§£: ${fuAns}ç¬¦ / ${hanAns}ç¿»`;
    document.getElementById('yakuLine').textContent = lastYakuList.length ? lastYakuList.join('ï¼') : 'ï¼ˆå½¹ãªã—ï¼‰';
    document.getElementById('fuLine').textContent  = lastFuBreak.length ? lastFuBreak.join('ï¼') : '';
    resetSelectors();
  }

  btnJudge.addEventListener('click', judge);
  btnReveal.addEventListener('click', reveal);
  btnNext.addEventListener('click', next);
  window.addEventListener('keydown', e=>{ if(e.key==='Enter') judge(); if(e.key.toLowerCase()==='n') next(); });

  // å½¹ãƒ¡ãƒ¢ï¼šã‚¯ãƒªãƒƒã‚¯ã§è–„é»„è‰²ãƒˆã‚°ãƒ«
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('yakuBtn')) {
      e.target.classList.toggle('selected');
    }
  });

  // ====== å½¹ãƒ¡ãƒ¢ â†” ç‚¹æ•°è¡¨ åˆ‡æ›¿ & ç‚¹æ•°è¡¨ç”Ÿæˆ ======
  const tabMemo  = document.getElementById('tabMemo');
  const tabScore = document.getElementById('tabScore');
  const panelMemo  = document.getElementById('panelMemo');
  const panelScore = document.getElementById('panelScore');
  const scoreTablesHost = document.getElementById('scoreTables');

  tabMemo.addEventListener('click', () => {
    tabMemo.classList.add('active'); tabScore.classList.remove('active');
    panelMemo.hidden = false; panelScore.hidden = true;
  });
  tabScore.addEventListener('click', () => {
    tabScore.classList.add('active'); tabMemo.classList.remove('active');
    panelMemo.hidden = true; panelScore.hidden = false;
  });

  const FU_ROWS = ['20ç¬¦','25ç¬¦','30ç¬¦','40ç¬¦','50ç¬¦','60ç¬¦'];
  const HAN_HEAD = ['1é£œ','2é£œ','3é£œ','4é£œ','5é£œ'];
  const CHILD = [
    ['----','400/700','700/1300','1300/2600','æº€è²«'],
    ['----','1600','3200','6400','æº€è²«'],
    ['1000','2000','3900','æº€è²«','æº€è²«'],
    ['1300','2600','5200','æº€è²«','æº€è²«'],
    ['1600','3200','6400','æº€è²«','æº€è²«'],
    ['2000','3900','æº€è²«','æº€è²«','æº€è²«'],
  ];
  const PARENT = [
    ['----','700ã‚ªãƒ¼ãƒ«','1300ã‚ªãƒ¼ãƒ«','2600ã‚ªãƒ¼ãƒ«','4000ã‚ªãƒ¼ãƒ«'],
    ['----','2400','4800','9600','æº€è²«'],
    ['1500','2900','5800','æº€è²«','æº€è²«'],
    ['2000','3900','7700','æº€è²«','æº€è²«'],
    ['2400','4800','9600','æº€è²«','æº€è²«'],
    ['2900','5800','æº€è²«','æº€è²«','æº€è²«'],
  ];

  function buildTable(title, kind, bodyData){
    const card = document.createElement('div');
    card.className = `scoreCard ${kind}`;
    const h4 = document.createElement('h4'); h4.textContent = title; card.appendChild(h4);
    const table = document.createElement('table'); table.className = 'scoreTable';

    const trHead = document.createElement('tr');
    const th0 = document.createElement('th'); th0.className='head'; th0.textContent='';
    trHead.appendChild(th0);
    HAN_HEAD.forEach(h => { const th = document.createElement('th'); th.className='head'; th.textContent=h; trHead.appendChild(th); });
    table.appendChild(trHead);

    for(let r=0;r<FU_ROWS.length;r++){
      const tr=document.createElement('tr');
      const thFu=document.createElement('th'); thFu.className='fu'; thFu.textContent=FU_ROWS[r]; tr.appendChild(thFu);
      for(let c=0;c<HAN_HEAD.length;c++){
        const td=document.createElement('td'); td.textContent = bodyData[r][c];
        td.addEventListener('click', (e) => {
          document.querySelectorAll('.scoreTable td.picked')
                  .forEach(x => x.classList.remove('picked'));
          e.currentTarget.classList.add('picked');
        });
        tr.appendChild(td);
      }
      table.appendChild(tr);
    }
    card.appendChild(table);
    return card;
  }

  (function initScoreTables(){
    if(!scoreTablesHost) return;
    scoreTablesHost.innerHTML='';
    scoreTablesHost.appendChild(buildTable('å­ã®ç‚¹æ•°','child',CHILD));
    scoreTablesHost.appendChild(buildTable('è¦ªã®ç‚¹æ•°','parent',PARENT));
  })();

  /* ===== ç‰Œã‚µã‚¤ã‚ºï¼ˆâª/â©ï¼‰ï¼š20â€“80pxï¼5pxåˆ»ã¿ ===== */
  const SIZE_MIN=20, SIZE_MAX=80, SIZE_STEP=5;
  const LS_SIZE_KEY = 'tileSizePx_hufan';
  let sizePx = +(localStorage.getItem(LS_SIZE_KEY) || 44);

  function clamp(v,min,max){ return v<min?min:v>max?max:v; }
  function applySize(px){
    sizePx = clamp(px, SIZE_MIN, SIZE_MAX);
    document.documentElement.style.setProperty('--w', sizePx + 'px');
    document.documentElement.style.setProperty('--h', Math.round(sizePx * 1.45) + 'px');
    if(sizeLabel) sizeLabel.textContent = sizePx + 'px';
    try{ localStorage.setItem(LS_SIZE_KEY, String(sizePx)); }catch(_){}
  }
  function hookSizeButtons(){
    if(sizeDown && !sizeDown.__bound){ sizeDown.addEventListener('click', ()=> applySize(sizePx - SIZE_STEP)); sizeDown.__bound = true; }
    if(sizeUp   && !sizeUp.__bound  ){ sizeUp  .addEventListener('click', ()=> applySize(sizePx + SIZE_STEP)); sizeUp  .__bound = true; }
  }

  /* åˆå›ï¼šã‚µã‚¤ã‚ºåæ˜  â†’ ãƒœã‚¿ãƒ³çµç·š â†’ å•é¡Œç”Ÿæˆ */
  function boot(){
    applySize(sizePx);
    hookSizeButtons();
    next();
  }
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', () => { try{ boot(); }catch(e){ console.error(e); } });
  }else{
    try{ boot(); }catch(e){ console.error(e); }
  }
})();
</script>
</body>
</html>
